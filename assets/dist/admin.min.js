!function(){"use strict";const e=window.jQuery;var t=class{constructor(e={}){this.options={containerSelector:"#ace-redis-settings-form",saveButtonSelector:"#ace-redis-save-btn",messageContainerSelector:"#ace-redis-messages",onSave:null,...e},this.isInitialized=!1,this.hasUnsavedChanges=!1,this.isSaving=!1;try{const e=localStorage.getItem("ace_redis_auto_save_enabled");null===e?("boolean"==typeof this.options.autoSaveEnabled?this.isAutoSaveEnabled=this.options.autoSaveEnabled:this.isAutoSaveEnabled=!0,localStorage.setItem("ace_redis_auto_save_enabled",this.isAutoSaveEnabled?"1":"0")):this.isAutoSaveEnabled="1"===e}catch(e){this.isAutoSaveEnabled=!0}this.isSuccess=!1,this.message="",this.elapsedTime=0,this.intervalId=null,this.originalFormData=null,this.init()}init(){this.isInitialized||(this.createSaveBar(),this.setupEventListeners(),this.captureOriginalFormData(),this.updateSaveButtonState(),this.isInitialized=!0)}createSaveBar(){if(document.querySelector(".ace-redis-save-bar"))return;const e=`\n            <div class="ace-redis-save-bar">\n                <div class="save-bar-content">\n                    <div class="save-bar-left">\n                        <span class="save-message"></span>\n                    </div>\n                    <div class="save-bar-right">\n                        <div class="auto-save-toggle-wrapper">\n                            <label class="ace-switch" for="auto-save-toggle">\n                                <input type="checkbox" id="auto-save-toggle" ${this.isAutoSaveEnabled?"checked":""}>\n                                <span class="ace-slider"></span>\n                            </label>\n                            <span class="toggle-label">Auto-save</span>\n                        </div>\n                        <button type="button" id="save-bar-button" class="button button-primary" disabled>\n                            <span class="dashicons dashicons-admin-settings"></span>\n                            <span class="button-text">Saved</span>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",e),this.updateFixedPosition()}setupEventListeners(){e(this.options.containerSelector).on("input change","input, select, textarea",()=>{setTimeout(()=>this.checkForChanges(),10)}),e(document).on("click","#save-bar-button",e=>{e.preventDefault(),this.handleSave()}),e(document).on("change","#auto-save-toggle",()=>{this.toggleAutoSave()}),e(window).on("resize scroll load",()=>this.updateFixedPosition()),e(window).on("beforeunload",e=>{if(this.hasUnsavedChanges&&!this.isSaving){const t="You have unsaved changes. Are you sure you want to leave?";return e.originalEvent.returnValue=t,t}}),window.wp&&wp.hooks&&wp.hooks.addAction("wp-collapse-menu","ace-redis-cache",()=>{setTimeout(()=>this.updateFixedPosition(),300)})}updateFixedPosition(){const e=document.querySelector(".ace-redis-save-bar");if(!e)return;const t=document.querySelector("#adminmenuwrap");if(t){const s=t.offsetWidth;e.style.left=`${s}px`}}captureOriginalFormData(){const t=e(this.options.containerSelector);this.originalFormData=this.getFormDataObject(t)}getFormDataObject(t){const s={};return t.serializeArray().forEach(e=>{if(e.name.startsWith("ace_redis_cache_settings[")){const t=e.name.replace("ace_redis_cache_settings[","").replace("]","");s[t]=e.value}}),t.find('input[type="checkbox"]').each(function(){const t=e(this).attr("name");if(t&&t.startsWith("ace_redis_cache_settings[")){const a=t.replace("ace_redis_cache_settings[","").replace("]","");s[a]=e(this).is(":checked")?"1":"0"}}),s}checkForChanges(){if(!this.originalFormData)return;const t=e(this.options.containerSelector),s=this.getFormDataObject(t),a=JSON.stringify(this.originalFormData)!==JSON.stringify(s);this.setUnsavedChanges(a)}setUnsavedChanges(e){this.hasUnsavedChanges!==e&&(this.hasUnsavedChanges=e,this.updateSaveButtonState(),e?(this.startElapsedTimeTracking(),this.isAutoSaveEnabled&&setTimeout(()=>this.handleAutoSave(),500)):this.stopElapsedTimeTracking())}updateSaveButtonState(){const t=e("#save-bar-button"),s=t.find(".button-text"),a=t.find(".dashicons");this.isSaving?(t.prop("disabled",!0).removeClass("success"),s.text("Saving..."),a.removeClass("dashicons-admin-settings dashicons-yes-alt").addClass("dashicons-update")):this.isSuccess?(t.prop("disabled",!0).addClass("success"),s.text("Saved!"),a.removeClass("dashicons-admin-settings dashicons-update").addClass("dashicons-yes-alt")):this.hasUnsavedChanges?(t.prop("disabled",!1).removeClass("success"),s.text("Save Changes"),a.removeClass("dashicons-update dashicons-yes-alt").addClass("dashicons-admin-settings")):(t.prop("disabled",!0).removeClass("success"),s.text("Saved"),a.removeClass("dashicons-update dashicons-yes-alt").addClass("dashicons-admin-settings"))}async handleSave(){if(this.hasUnsavedChanges&&!this.isSaving){this.setSaving(!0);try{let e=!1;e=this.options.onSave&&"function"==typeof this.options.onSave?await this.options.onSave():await this.defaultSave(),e?(this.showMessage("Settings saved successfully!","success"),this.setSuccess(!0),this.captureOriginalFormData(),this.setUnsavedChanges(!1),setTimeout(()=>this.setSuccess(!1),3e3)):this.showMessage("Save failed. Please try again.","error")}catch(e){console.error("Save error:",e),this.showMessage("An error occurred while saving.","error")}finally{this.setSaving(!1)}}}async handleAutoSave(){if(this.hasUnsavedChanges&&!this.isSaving){console.log("[SaveBar] Auto-saving changes..."),this.showMessage("Auto-saving...","info");try{let e=!1;e=this.options.onSave&&"function"==typeof this.options.onSave?await this.options.onSave():await this.defaultSave(),e?(this.showMessage("Changes auto-saved!","success"),this.captureOriginalFormData(),this.setUnsavedChanges(!1)):this.showMessage("Auto-save failed","error")}catch(e){console.error("[SaveBar] Auto-save error:",e),this.showMessage("Auto-save error occurred","error")}}}async defaultSave(){return new Promise(t=>{const s=e(this.options.containerSelector),a=this.getFormDataObject(s);e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/settings",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{settings:a,nonce:ace_redis_admin.nonce},success:e=>{t(!0===e.success)},error:()=>{t(!1)}})})}setSaving(e){this.isSaving=e,this.updateSaveButtonState()}setSuccess(e){this.isSuccess=e,this.updateSaveButtonState()}showMessage(e,t="info"){this.message=e,this.updateMessageDisplay(t),"success"===t&&this.startElapsedTimeTracking();setTimeout(()=>{this.clearMessage()},"error"===t?8e3:"success"===t?5e3:3e3)}updateMessageDisplay(t="info"){const s=e(".save-message");this.message?s.text(this.message).addClass("visible").removeClass("error success info").addClass(t):s.removeClass("visible error success info").text("")}clearMessage(){this.message="",this.updateMessageDisplay(),this.stopElapsedTimeTracking()}startElapsedTimeTracking(){this.stopElapsedTimeTracking(),this.elapsedTime=0,this.intervalId=setInterval(()=>{this.elapsedTime++,this.updateElapsedTimeDisplay()},1e3)}stopElapsedTimeTracking(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}updateElapsedTimeDisplay(){if(this.elapsedTime>0){const t=this.formatElapsedTime(this.elapsedTime);e(".save-message").text(t)}}formatElapsedTime(e){return e<60?`${e}s ago`:e<3600?`${Math.floor(e/60)}m ago`:`${Math.floor(e/3600)}h ago`}toggleAutoSave(){const t=e("#auto-save-toggle");this.isAutoSaveEnabled=t.is(":checked"),this.isAutoSaveEnabled?this.showMessage("Auto-save enabled - changes will be saved automatically","success"):this.showMessage("Auto-save disabled - manual save required","info");try{localStorage.setItem("ace_redis_auto_save_enabled",this.isAutoSaveEnabled?"1":"0")}catch(e){}if("undefined"!=typeof ace_redis_admin&&ace_redis_admin.ajax_url)try{jQuery.post(ace_redis_admin.ajax_url,{action:"ace_redis_toggle_autosave",nonce:ace_redis_admin.nonce,enabled:this.isAutoSaveEnabled?1:0})}catch(e){}}destroy(){this.stopElapsedTimeTracking(),e(this.options.containerSelector).off("input change"),e(document).off("click","#save-bar-button"),e(document).off("change","#auto-save-toggle"),e(window).off("resize scroll load"),e(window).off("beforeunload"),e(".ace-redis-save-bar").remove(),this.isInitialized=!1}};!function(e){window.AceRedisCacheSaveBar=t;class s{constructor(){this.originalFormData=null,this.pluginMemoryAuto=!1,this.pluginMemoryFetching=!1,this.transientEnableTs=null,this.init()}init(){this.initTabs(),this.initToggleSwitch(),this.initEnableCacheUi(),this.initCacheMode(),this.initConnectionTest(),this.initCacheManagement(),this.initDiagnostics(),this.initPerformanceMetrics(),this.initAjaxForm(),this.initFormValidation(),this.initChangeTracking(),this.initSaveBar(),this.initCompressionToggle(),this.initOpcacheHelpers(),this.initManagedPlugins(),this.initTransientHealth(),this.initHealthActions()}initEnableCacheUi(){const t=()=>{const t=e("#enable_cache").is(":checked"),s=e(".cache-actions-panel .cache-action-buttons");s.length&&s.toggle(!!t),e("#ace-redis-cache-test-btn").prop("disabled",!t),e("#ace-redis-cache-test-write-btn").prop("disabled",!t)};t(),e(document).on("change","#enable_cache",t)}initSaveBar(){if(void 0!==window.AceRedisCacheSaveBar){let e=!1;if("undefined"!=typeof ace_redis_admin&&null!==ace_redis_admin.user_auto_save)e=!!ace_redis_admin.user_auto_save;else try{const t=localStorage.getItem("ace_redis_auto_save_enabled");null!==t&&(e="1"===t)}catch(e){}this.saveBar=new window.AceRedisCacheSaveBar({containerSelector:"#ace-redis-settings-form",saveButtonSelector:"#ace-redis-save-btn",messageContainerSelector:"#ace-redis-messages",onSave:()=>this.saveSettingsViaSaveBar(),autoSaveEnabled:e,autoSaveInterval:15e3}),console.log("SaveBar initialized successfully")}else console.warn("SaveBar component not loaded, falling back to standard save handling")}async saveSettingsViaSaveBar(){try{const e=await this.performSaveSettings();return e&&setTimeout(()=>{"function"==typeof this.testConnection&&this.testConnection()},1e3),e}catch(e){return console.error("SaveBar save error:",e),!1}}async performSaveSettings(){return new Promise(t=>{e("#ace-redis-settings-form");const s=this.getFormDataObject();s.__managed_plugins=this.collectManagedPlugins(),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/settings",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{settings:s,nonce:ace_redis_admin.nonce},success:s=>{s.success?(this.captureOriginalFormData(),e("#enable_transient_cache").is(":checked")?this.transientEnableTs=Date.now():this.transientEnableTs=null,setTimeout(()=>this.refreshTransientHealth&&this.refreshTransientHealth(),300),t(!0)):t(!1)},error:()=>{t(!1)}})})}collectManagedPlugins(){const t={};return e(".ace-mp-enable").each(function(){e(this).is(":checked")&&(t[e(this).data("plugin-file")]={enabled_on_init:1})}),t}initManagedPlugins(){}initTransientHealth(){e("#enable_transient_cache").length&&(setTimeout(()=>this.refreshTransientHealth(),500),this.transientInitPoll=null)}refreshTransientHealth(){const t=e("#ace-rc-transient-status"),s=e("#ace-rc-transient-tips");if(!t.length)return;if(!e("#enable_transient_cache").is(":checked"))return this.setTransientStatus("Off","pending"),s.length&&s.html("<em>Transient cache disabled.</em>").data("populated",!0),void(this.transientInitPoll&&(clearInterval(this.transientInitPoll),this.transientInitPoll=null));t.text("checking").css({background:"#ddd",color:"#333"}),s.length&&!s.data("populated")&&s.html("Loading cache health…"),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/health",type:"GET",beforeSend:e=>e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)}).done(t=>{if(!t||!t.success||!t.data)return this.setTransientStatus("error","error"),void(s.length&&s.html('<span style="color:#c00;">Unable to load cache health.</span>'));const a=t.data;let i="ok",n="OK";a.using_dropin?a.dropin_connected?a.bypass&&(i="warn",n="Bypassed"):(i="error",n="Down"):(i="warn",n="Missing");const o=Date.now();if(this.transientEnableTs&&o-this.transientEnableTs<15e3&&"ok"!==i&&(i="init",n="Init"),this.setTransientStatus(n,i),"Init"===n?this.transientInitPoll||(this.transientInitPoll=setInterval(()=>{if(!e("#enable_transient_cache").is(":checked"))return clearInterval(this.transientInitPoll),void(this.transientInitPoll=null);if("Init"!==e("#ace-rc-transient-status").text())return clearInterval(this.transientInitPoll),void(this.transientInitPoll=null);this.refreshTransientHealth()},1e4)):this.transientInitPoll&&(clearInterval(this.transientInitPoll),this.transientInitPoll=null),s.length){const e=[];e.push("<strong>Drop-in:</strong> "+(a.using_dropin?a.dropin_connected?'<span style="color:green;">connected</span>':'<span style="color:#c00;">not connected</span>':'<span style="color:#c00;">missing</span>')),a.bypass&&e.push('<span style="color:#c00;">bypass active</span>'),e.push("Autoload "+this.humanApproxBytes(a.autoload_size)),a.slow_ops&&e.push(a.slow_ops+" slow ops"),a.error&&e.push("Error: <code>"+this.escapeHtml(a.error)+"</code>");let t=e.join(" | ");Array.isArray(a.tips)&&a.tips.length&&(t+='<ul style="margin:6px 0 0 18px; list-style:disc;">'+a.tips.map(e=>"<li>"+this.escapeHtml(e)+"</li>").join("")+"</ul>"),"init"===i&&(t="<strong>Initializing:</strong> Deploying drop-in / establishing Redis connection. This can take a few seconds on first enable.<br>"+t),s.html(t).data("populated",!0)}}).fail(()=>{this.setTransientStatus("error","error"),s.length&&s.html('<span style="color:#c00;">Health request failed.</span>')})}setTransientStatus(t,s){const a=e("#ace-rc-transient-status");if(!a.length)return;const i={ok:{bg:"#46b450",fg:"#fff"},warn:{bg:"#dba617",fg:"#1d2327"},error:{bg:"#d63638",fg:"#fff"},pending:{bg:"#888",fg:"#fff"},init:{bg:"#2271b1",fg:"#fff"}},n=i[s]||i.pending;a.text(t).css({background:n.bg,color:n.fg})}humanApproxBytes(e){if(!e)return"0B";const t=["B","KB","MB","GB","TB"];let s=0,a=e;for(;a>=1024&&s<t.length-1;)a/=1024,s++;return(a>=10?Math.round(a):a.toFixed(1))+t[s]}initHealthActions(){const t=e("#ace-rc-reset-slow-ops");t.length&&t.on("click",()=>{e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/settings",type:"POST",beforeSend:e=>e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce),data:{reset_slow_ops:1,nonce:ace_redis_admin.nonce},success:()=>{e("#ace-rc-slow-ops-val").text("0")}})})}initTabs(){e(".nav-tab").on("click",t=>{t.preventDefault();const s=e(t.target).attr("href");this.switchToTab(s),s.startsWith("#")&&(window.location.hash=s)}),e(window).on("hashchange",()=>{this.handleHashChange()}),this.handleHashChange()}switchToTab(t){t&&e(t).length&&(e(".nav-tab").removeClass("nav-tab-active"),e(`.nav-tab[href="${t}"]`).addClass("nav-tab-active"),e(".tab-content.active").removeClass("active"),setTimeout(()=>{e(t).addClass("active"),"#diagnostics"===t?(setTimeout(()=>{this.loadPerformanceMetrics({scope:"basic"})},100),this.resumeAutoRefreshTimer()):this.pauseAutoRefreshTimer()},50))}handleHashChange(){let t=window.location.hash;if(!t||!e(t).length){const s=e(".nav-tab").first().attr("href");s&&(t=s)}t&&e(t).length&&this.switchToTab(t)}initToggleSwitch(){e(".ace-switch input").on("change",function(){const t=e(this),s=t.siblings(".ace-slider");t.is(":checked")?s.addClass("checked"):s.removeClass("checked")})}initCacheMode(){const t=()=>{const t=e("#enable_object_cache").is(":checked"),s=e("#block-caching-row"),a=e("#transient-cache-row");s.toggle(!!t),a.toggle(!!t)},s=()=>{const t=e("#enable_page_cache").is(":checked"),s=e("#enable_object_cache").is(":checked"),a=e("#ttl_page").closest(".cache-type-options"),i=e("#ttl_object").closest(".cache-type-options");a.length&&a.toggle(!!t),i.length&&i.toggle(!!s)};t(),s(),e("#enable_object_cache").on("change",function(){t(),s()}),e("#enable_page_cache").on("change",function(){s()})}initCompressionToggle(){const t=()=>{const t=e("#enable_compression").is(":checked"),s=e("#enable_compression").closest(".setting-field");s.length&&(s.find(".compression-methods").toggle(!!t),s.find(".compression-methods").next("p.description").toggle(!!t))};t(),e(document).on("change","#enable_compression",t)}initOpcacheHelpers(){if(!e("#enable_opcache_helpers").length)return;const t=e("#opcache-helper-buttons"),s=e("#enable_opcache_helpers"),a=()=>{const e=s.is(":checked");t.toggle(e),e&&this.fetchOpcacheStatus()};s.on("change",a),a(),e("#ace-redis-opcache-reset").on("click",e=>{e.preventDefault(),this.callOpcacheEndpoint("opcache-reset",e.currentTarget)}),e("#ace-redis-opcache-prime").on("click",e=>{e.preventDefault(),this.callOpcacheEndpoint("opcache-prime",e.currentTarget)})}callOpcacheEndpoint(t,s){const a=e(s),i=a.text();a.prop("disabled",!0).text("Working..."),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/"+t,method:"POST",beforeSend:e=>e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce),data:{nonce:ace_redis_admin.nonce}}).done(e=>{if(e&&e.success){let t="✅ "+(e.message||"Success");e.files&&e.files.length&&(t+="\nFiles: "+e.files.join(", ")),alert(t),this.fetchOpcacheStatus()}else alert("❌ "+(e&&e.message?e.message:"Failed"))}).fail(()=>{alert("❌ Request failed")}).always(()=>{a.prop("disabled",!1).text(i)})}fetchOpcacheStatus(){e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/opcache-status",method:"GET",beforeSend:e=>e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)}).done(t=>{if(t&&t.success&&t.data){const s=t.data;let a="OPcache: "+(s.enabled?"Enabled":"Disabled");if(null!==s.cached_scripts&&(a+=" | Scripts: "+s.cached_scripts),null!==s.hit_rate){const e=parseFloat(s.hit_rate);isNaN(e)||(a+=" | HitRate: "+e.toFixed(1)+"%")}let i=e(".opcache-status-inline");i.length||(i=e('<span class="opcache-status-inline" style="margin-left:8px; font-size:11px; opacity:0.8;"></span>'),e("#opcache-helper-buttons").append(i)),i.text(a)}})}initConnectionTest(){e("#ace-redis-cache-test-btn").on("click",e=>{e.preventDefault(),this.testConnection()}),e("#ace-redis-cache-test-write-btn").on("click",e=>{e.preventDefault(),this.testWriteRead()})}testConnection(){const t=e("#ace-redis-cache-test-btn"),s=t.text();t.text("Testing...").prop("disabled",!0),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/test-connection",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{nonce:ace_redis_admin.nonce}}).done(e=>{e.success?this.updateConnectionStatus(e.data):this.showConnectionError(e.data||"Connection failed")}).fail(()=>{this.showConnectionError("REST API request failed")}).always(()=>{t.text(s).prop("disabled",!1)})}testWriteRead(){const t=e("#ace-redis-cache-test-write-btn"),s=t.text();t.text("Testing...").prop("disabled",!0),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/test-write-read",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{nonce:ace_redis_admin.nonce}}).done(e=>{e.success?this.showNotification(`✅ Write/Read Test Successful\nWrite: ${e.data.write}\nRead: ${e.data.read}\nValue: ${e.data.value}`,"success"):this.showNotification(`❌ Test failed: ${e.data}`,"error")}).fail(()=>{this.showNotification("❌ REST API request failed","error")}).always(()=>{t.text(s).prop("disabled",!1)})}updateConnectionStatus(t){const s=e("#ace-redis-cache-connection"),a=e("#ace-redis-cache-size"),i=e("#redis-server-info"),n=e("#redis-server-type"),o=e("#redis-suggestions");s.text(t.status).removeClass("status-unknown status-error").addClass("status-success");let r=`${t.size} keys (${t.size_kb} KB)`;if(t.debug_info&&(r+=` - ${t.debug_info}`),a.text(r),t.server_type||t.suggestions){if(n.text(t.server_type||"Unknown"),t.suggestions&&t.suggestions.length>0){let e="<p><strong>Recommendations:</strong></p><ul>";t.suggestions.forEach(t=>{e+=`<li>${t}</li>`}),e+="</ul>",o.html(e)}else o.html("<p><strong>Recommendations:</strong> Configuration looks good ✅</p>");i.slideDown(300)}}showConnectionError(t){const s=e("#ace-redis-cache-connection"),a=e("#ace-redis-cache-size"),i=e("#redis-server-info");s.text(t).removeClass("status-unknown status-success").addClass("status-error"),a.text("0 keys (0 KB)"),i.slideUp(300)}initCacheManagement(){e("#ace-redis-cache-flush-btn").on("click",e=>{e.preventDefault(),this.clearAllCache()})}clearAllCache(){if(!confirm("Are you sure you want to clear all cache? This action cannot be undone."))return;const t=e("#ace-redis-cache-flush-btn"),s=t.text();t.text("Clearing...").prop("disabled",!0),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/flush-cache",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{nonce:ace_redis_admin.nonce,type:"all"}}).done(t=>{t.success?(this.showNotification(`✅ ${t.data.message||"Cache cleared successfully"}`,"success"),e("#ace-redis-cache-size").text("0 keys (0 KB)")):this.showNotification(`❌ Failed to clear cache: ${t.data}`,"error")}).fail(()=>{this.showNotification("❌ REST API request failed","error")}).always(()=>{t.text(s).prop("disabled",!1)})}initDiagnostics(){e("#ace-redis-cache-diagnostics-btn").on("click",e=>{e.preventDefault(),this.runDiagnostics()})}runDiagnostics(){const t=e("#ace-redis-cache-diagnostics-btn"),s=e("#diagnostics-results"),a=t.text();t.text("Running...").prop("disabled",!0),s.html("<p>⏳ Running comprehensive diagnostics...</p>"),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/diagnostics",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{nonce:ace_redis_admin.nonce}}).done(e=>{if(e.success&&e.data){const t=Array.isArray(e.data)?e.data.join("\n"):e.data;s.html(`<pre>${this.escapeHtml(t)}</pre>`)}else s.html(`<p class="error">❌ Failed to load diagnostics: ${e.data||"Unknown error"}</p>`)}).fail(()=>{s.html('<p class="error">❌ Diagnostics REST API request failed</p>')}).always(()=>{t.text(a).prop("disabled",!1)})}initFormValidation(){e("#ace-redis-save-btn").on("click",e=>{if(!this.validateForm())return e.preventDefault(),!1}),e("#redis_host").on("blur",this.validateHost),e("#redis_port").on("blur",this.validatePort),e("#ttl_page, #ttl_object").on("blur",this.validateTTL)}validateForm(){let t=!0;const s=[];e("#redis_host").val().trim()||(s.push("Redis host is required"),t=!1);const a=parseInt(e("#redis_port").val());(!a||a<1||a>65535)&&(s.push("Redis port must be between 1 and 65535"),t=!1);const i=parseInt(e("#ttl_page").val()),n=parseInt(e("#ttl_object").val());return(!i||i<60)&&(s.push("Page Cache TTL must be at least 60 seconds"),t=!1),(!n||n<60)&&(s.push("Object Cache TTL must be at least 60 seconds"),t=!1),t||this.showNotification(`❌ Validation errors:\n${s.join("\n")}`,"error"),t}validateHost(){const t=e(this);return t.val().trim()?(t.removeClass("error"),!0):(t.addClass("error"),!1)}validatePort(){const t=e(this),s=parseInt(t.val());return!s||s<1||s>65535?(t.addClass("error"),!1):(t.removeClass("error"),!0)}validateTTL(){const t=e(this),s=parseInt(t.val());return!s||s<60?(t.addClass("error"),!1):(t.removeClass("error"),!0)}showNotification(e,t="info"){alert(e)}initAjaxForm(){console.log("Initializing AJAX form..."),e("#ace-redis-settings-form").on("submit",e=>(console.log("Form submit intercepted"),e.preventDefault(),e.stopPropagation(),this.saveSettings(),!1)),e("#ace-redis-save-btn").on("click",e=>(console.log("Save button clicked"),e.preventDefault(),e.stopPropagation(),this.saveSettings(),!1))}initChangeTracking(){setTimeout(()=>{const t=e("#ace-redis-save-btn");t.data("original-text")||t.data("original-text",t.val()),this.captureOriginalFormData(),this.updateSaveButtonState(),e("#ace-redis-settings-form input, #ace-redis-settings-form select, #ace-redis-settings-form textarea").on("input change",()=>{setTimeout(()=>this.updateSaveButtonState(),10)})},100)}captureOriginalFormData(){this.originalFormData=this.getFormDataObject()}hasFormChanges(){if(!this.originalFormData)return!1;const e=this.getFormDataObject();return JSON.stringify(this.originalFormData)!==JSON.stringify(e)}updateSaveButtonState(){const t=e("#ace-redis-save-btn"),s=this.hasFormChanges();t.prop("disabled",!s),s?t.val(t.data("original-text")||"Save Changes"):t.val(t.data("original-text")||"Save Changes (No Changes)")}getFormDataObject(){const t=e("#ace-redis-settings-form"),s={};return t.serializeArray().forEach(e=>{if(e.name.startsWith("ace_redis_cache_settings[")){const t=e.name.replace("ace_redis_cache_settings[","").replace("]","");s[t]=e.value}}),t.find('input[type="checkbox"]').each(function(){const t=e(this).attr("name");if(t&&t.startsWith("ace_redis_cache_settings[")){const a=t.replace("ace_redis_cache_settings[","").replace("]","");s[a]=e(this).is(":checked")?"1":"0"}}),s}saveSettings(){this.saveBar?this.saveBar.handleSave():this.performOriginalSave()}performOriginalSave(){if(!this.hasFormChanges())return void this.showMessage("Error: Failed to save settings. No changes detected or database error.","error");e("#ace-redis-settings-form");const t=e("#ace-redis-save-btn"),s=e("#ace-redis-messages");console.log("REST API Save triggered...");const a=t.val();t.val("Saving...").prop("disabled",!0),s.hide();const i=this.getFormDataObject();console.log("Sending data:",i),console.log("REST URL:",ace_redis_admin.rest_url+"ace-redis-cache/v1/settings"),e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/settings",type:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce),console.log("Set REST nonce:",ace_redis_admin.rest_nonce)},data:{settings:i,nonce:ace_redis_admin.nonce},success:e=>{console.log("Success response:",e),e.success?(this.showMessage(e.message||"Settings saved successfully!","success"),this.captureOriginalFormData(),this.updateSaveButtonState(),setTimeout(()=>{"function"==typeof this.testConnection&&this.testConnection()},1e3)):this.showMessage(e.message||"Failed to save settings","error")},error:(e,t,s)=>{console.error("Save error:",{status:e.status,statusText:e.statusText,responseText:e.responseText,error:s});let a="Network error occurred";a=e.responseJSON&&e.responseJSON.message?e.responseJSON.message:504===e.status?"Gateway timeout - settings may still be saved. Please refresh the page.":403===e.status?"Permission denied. Please refresh the page and try again.":404===e.status?"REST API endpoint not found. The plugin may not be properly configured.":`${s} (Status: ${e.status})`,this.showMessage("Error: "+a,"error")},complete:()=>{t.val(a).prop("disabled",!1)}})}showMessage(t,s="success"){const a=e("#ace-redis-messages"),i="success"===s?"notice-success":"notice-error";a.html(`\n                <div class="notice ${i} is-dismissible">\n                    <p>${this.escapeHtml(t)}</p>\n                    <button type="button" class="notice-dismiss">\n                        <span class="screen-reader-text">Dismiss this notice.</span>\n                    </button>\n                </div>\n            `).show(),"success"===s&&setTimeout(()=>{a.fadeOut()},5e3),a.find(".notice-dismiss").on("click",function(){a.fadeOut()})}initPerformanceMetrics(){e("#diagnostics").hasClass("active")&&setTimeout(()=>{this.loadPerformanceMetrics({scope:"basic"})},100),this.initAutoRefresh(),e("#refresh-metrics-btn").on("click",()=>{this.loadPerformanceMetrics({scope:"basic"});const t=e("#refresh-metrics-btn");t.prop("disabled",!0).html("⏳"),setTimeout(()=>{t.prop("disabled",!1).html("🔄")},1e3)}),e("#performance-metrics").on("click",".fetch-plugin-memory",t=>{t.preventDefault();e(t.currentTarget).is(":disabled")||(this.pluginMemoryAuto=!this.pluginMemoryAuto,this.updatePluginMemoryToggleUI(),this.pluginMemoryAuto&&this.fetchPluginMemory(!0))})}initAutoRefresh(){this.autoRefreshInterval=null,this.countdownInterval=null,this.remainingSeconds=0;const t=()=>{const t=e("#refresh-timer");this.remainingSeconds>0?(t.text(`Next refresh in ${this.remainingSeconds}s`),this.remainingSeconds--):t.text("")};this.startAutoRefresh=s=>{this.autoRefreshInterval&&clearInterval(this.autoRefreshInterval),this.countdownInterval&&clearInterval(this.countdownInterval);const a=e("#refresh-timer");s>0?(this.remainingSeconds=s,this.countdownInterval=setInterval(t,1e3),this.autoRefreshInterval=setInterval(()=>{e("#diagnostics").hasClass("active")&&(this.loadPerformanceMetrics({scope:"basic"}),this.remainingSeconds=s)},1e3*s),t()):a.text("")},e("#auto-refresh-select").on("change",()=>{const t=parseInt(e("#auto-refresh-select").val());this.startAutoRefresh(t)}),this.startAutoRefresh(30)}pauseAutoRefreshTimer(){this.countdownInterval&&clearInterval(this.countdownInterval),e("#refresh-timer").text("")}resumeAutoRefreshTimer(){const t=parseInt(e("#auto-refresh-select").val());t>0&&this.startAutoRefresh(t)}loadPerformanceMetrics(t={}){if(!e("#diagnostics").hasClass("active"))return;const s=t.scope||"basic";e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/metrics",type:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)},data:{scope:s},success:t=>{if(e("#diagnostics").hasClass("active"))if(t&&t.data){const e=t.data;this.updateMetricsDisplay(e,s),!1===e.cache_enabled||"Cache is disabled"===t.message?this.annotateCacheDisabled():this.pluginMemoryAuto&&this.fetchPluginMemory(!1)}else t.data&&(this.updateMetricsDisplay(t.data,s),this.pluginMemoryAuto&&this.fetchPluginMemory(!1))},error:()=>{this.updateMetricsDisplay({cache_hit_rate:"--",total_keys:"--",memory_usage:"--",response_time:"--",uptime:"--",connected_clients:"--",ops_per_sec:"--"},s),this.pluginMemoryAuto&&this.fetchPluginMemory(!1)}})}updateMetricsDisplay(t,s="basic"){console.log("Debug keyspace stats:",{hits:t.debug_keyspace_hits,misses:t.debug_keyspace_misses,hit_rate:t.cache_hit_rate});const a=e("#metrics-scope-label");a.length&&a.text(`(${"full"===s?"full":"light"})`),e("#performance-metrics .metric-card").each(function(){const s=e(this),a=s.find(".metric-value"),i=s.find("h4").text(),n=s.data("metric");let o="--";switch(i){case"Cache Hit Rate":o=t.cache_hit_rate||"--";break;case"Total Keys":o=t.total_keys||"--";break;case"Memory Usage":o=t.memory_usage||"--";break;case"Plugin Memory":o=void 0!==t.plugin_memory_total&&null!==t.plugin_memory_total&&""!==t.plugin_memory_total?t.plugin_memory_total:a.text()||"--";const e=s.find(".metric-breakdown");if(void 0!==t.plugin_memory_total){const s=[];t.plugin_memory_page&&s.push(`Page ${t.plugin_memory_page}`),t.plugin_memory_minified&&s.push(`Minified ${t.plugin_memory_minified}`),t.plugin_memory_blocks&&s.push(`Blocks ${t.plugin_memory_blocks}`),t.plugin_memory_transients&&s.push(`Transients ${t.plugin_memory_transients}`),e.length&&e.text(s.length?` | ${s.join(" | ")}`:"")}break;case"Response Time":o=t.response_time||"--";break;case"Uptime":o=t.uptime||"--";break;case"Connected Clients":o=t.connected_clients||"--";break;case"Operations/sec":case"Ops/sec":o=0===t.ops_per_sec?"0":null!=t.ops_per_sec?t.ops_per_sec:"--";break;case"Connection Time":o=t.connection_time||"--"}a.text()!==o?a.fadeOut(100,function(){e(this).text(o).fadeIn(100)}):a.text(o);const r=s.find(".metric-note");if(r.length)if("--"===o){let e="";if(e="light mode","plugin_memory"===n)return void(this.pluginMemoryAuto?r.text("auto mode (updated periodically)").show():r.text("Click Fetch to compute plugin memory").show());"memory_usage"!==n&&"uptime"!==n&&"connected_clients"!==n||(e=e?`${e}; provider restrictions`:"provider restrictions"),r.text(e).show()}else r.text("").hide()});const i=(new Date).toLocaleTimeString();e(".metrics-last-updated").text(`Last updated: ${i}`)}annotateCacheDisabled(){e("#performance-metrics .metric-card").each(function(){const t=e(this).find(".metric-note");t.length&&t.text("cache disabled").show()});const t=e("#performance-metrics .fetch-plugin-memory");t.length&&t.prop("disabled",!0).attr("title","Enable cache to compute plugin memory"),this.pluginMemoryAuto=!1,this.updatePluginMemoryToggleUI()}updatePluginMemoryToggleUI(){const t=e("#performance-metrics .fetch-plugin-memory");t.length&&(t.is(":disabled")||(this.pluginMemoryAuto?t.text("Auto: On").addClass("is-on").attr("title","Disable auto plugin memory refresh"):t.text("Fetch").removeClass("is-on").attr("title","Fetch plugin memory and enable auto refresh")))}fetchPluginMemory(t=!0){if(this.pluginMemoryFetching)return;const s=e('#performance-metrics .metric-card[data-metric="plugin_memory"]');if(!s.length)return;const a=s.find(".plugin-memory-spinner"),i=s.find('[data-field="plugin_memory_total"]'),n=s.find(".metric-breakdown"),o=s.find(".metric-note");t&&(a.css("visibility","visible"),o.text(this.pluginMemoryAuto?"Auto computing…":"Computing…").show()),this.pluginMemoryFetching=!0,e.ajax({url:ace_redis_admin.rest_url+"ace-redis-cache/v1/plugin-memory",type:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ace_redis_admin.rest_nonce)}}).done(e=>{if(e&&e.success){const t=e.data||{};t.plugin_memory_total&&i.text(t.plugin_memory_total);const s=[];null!=t.plugin_page_keys&&s.push(`pages: ${t.plugin_page_keys}`),null!=t.plugin_block_keys&&s.push(`blocks: ${t.plugin_block_keys}`),null!=t.plugin_total_keys&&s.push(`total keys: ${t.plugin_total_keys}`);const a=[];t.plugin_memory_page&&a.push(`pages ${t.plugin_memory_page}`),t.plugin_memory_minified&&a.push(`minified ${t.plugin_memory_minified}`),t.plugin_memory_blocks&&a.push(`blocks ${t.plugin_memory_blocks}`),t.plugin_memory_transients&&a.push(`transients ${t.plugin_memory_transients}`);const r=[s.join(", "),a.join(", ")].filter(Boolean).join(" | ");r&&n.text(r);const c=(new Date).toLocaleTimeString();o.text(this.pluginMemoryAuto?`auto updated ${c}`:"Computed just now").show()}else o.text(e&&e.message?e.message:"Failed to fetch").show()}).fail(()=>{o.text("Failed to fetch").show()}).always(()=>{this.pluginMemoryFetching=!1,t&&a.css("visibility","hidden")})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}e(document).ready(()=>{new s})}(jQuery)}();
//# sourceMappingURL=admin.min.js.map